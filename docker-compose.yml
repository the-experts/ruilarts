
services:
  # PostgreSQL database for huisartsen-api
  db:
    image: postgres:15
    container_name: ruilarts-postgres
    environment:
      POSTGRES_DB: huisartsen
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - ruilarts-network

  # Neo4j database for backend-matching
  neo4j:
    image: neo4j:5.15
    container_name: ruilarts-neo4j
    ports:
      - "7474:7474"  # HTTP/Browser UI
      - "7687:7687"  # Bolt protocol
    environment:
      - NEO4J_AUTH=neo4j/ruilarts123
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - ruilarts-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Huisartsen API (Flask)
  huisartsen-api:
    build: ./huisartsen_api
    container_name: ruilarts-huisartsen-api
    depends_on:
      - db
    environment:
      POSTGRES_DB: huisartsen
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      POSTGRES_HOST: db
    ports:
      - "5001:5001"
    networks:
      - ruilarts-network

  # Location API (NODE)
  ruilarts-geo:
    build: ./backend-geo
    container_name: ruilarts-geo
    environment:
      NODE_ENV: production
    ports:
      - "4000:4000"
    networks:
      - ruilarts-network

  # Backend Matching API (Hono + Node.js + Neo4j)
  backend-matching:
    build: ./backend-matching
    container_name: ruilarts-backend-matching
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=ruilarts123
      - PORT=8000
      - MAX_PRACTICE_CHOICES=10
      - MAX_CIRCLE_SIZE=10
    ports:
      - "8000:8000"
    volumes:
      # Mount source code for hot-reload in development
      - ./backend-matching:/app
      # Exclude node_modules to use container's version
      - /app/node_modules
    networks:
      - ruilarts-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  pgdata:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:

networks:
  ruilarts-network:
    driver: bridge
